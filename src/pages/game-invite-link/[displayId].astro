---
import GameInviteLink from "../../components/game-invite-link/GameInviteLink";
import getGameInviteLinkData from "../../db/game-invite-link/getGameInviteLink";
import getGameResInviteLinkData from "../../db/game-invite-link/getGameResInviteLink";
import isGameInviteLinkValid from "../../db/game-invite-link/isGameInviteLinkValid";
import MainLayout from "../../layouts/main-layout.astro";

if (Astro.locals.user === undefined) {
  // should not happen as this is a protected route
  return new Response(null, { status: 500 });
}

const displayId = Astro.params.displayId as string;
const resGameInviteLinkData = await getGameResInviteLinkData(displayId);

if (resGameInviteLinkData === null) {
  return new Response(null, { status: 404, statusText: "Not found" });
}
const gameInviteLinkData = await getGameInviteLinkData(
  resGameInviteLinkData.id
);
const responseOrIsValid = await isGameInviteLinkValid(
  gameInviteLinkData,
  Astro.locals.user.id
);

if (responseOrIsValid !== true) {
  return responseOrIsValid;
}
const LDReceive = Astro.locals.langDict["game_invite_receive"];
---

<MainLayout title="Link z zaproszeniem">
  <GameInviteLink
    gameInviteLinkData={resGameInviteLinkData}
    langDict={LDReceive}
    client:load
  />
</MainLayout>

<script>
  import { initGameLocal } from "../../scripts/initLocalGame";
  initTempGame();

  function initTempGame() {
    const match = initGameLocal("[data-page-container]");
    match.end();
  }
</script>
