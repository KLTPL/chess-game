var K=Object.defineProperty;var B=(u,e,t)=>e in u?K(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var c=(u,e,t)=>(B(u,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerpolicy&&(n.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?n.credentials="include":i.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class d{constructor(e,t){c(this,"x");c(this,"y");this.y=e,this.x=t}invert(){this.y=f-1-this.y,this.x=f-1-this.x}isEqualTo(e){return this.x===e.x&&this.y===e.y}}class E{constructor(e){c(this,"html");c(this,"piece");this.html=e,this.piece=null}setPiece(e){this.piece=e}}class r extends d{constructor(e,t,s){super(e,t),s&&(this.y=this.simplifyDir(e),this.x=this.simplifyDir(t))}simplifyDir(e){return e>=1?1:e<=-1?-1:0}}class H{constructor(e,t){c(this,"piece");c(this,"grabbedFrom");this.piece=e,this.grabbedFrom=t}}const m={pawn:1,rook:2,knight:3,bishop:4,queen:5,king:6},g={white:1,black:2},A=30;class b{constructor(e,t){c(this,"value");c(this,"num");c(this,"team");c(this,"html");c(this,"board");c(this,"startFollowingCursor",e=>{const s=this.board.calcFieldCoorByPx(e.clientX,e.clientY),i=this.getPossibleMovesFromPos(s);if(this.board.currTeam!==this.team||e.button!==0||this.board.pawnPromotionMenu!==null||this.board.grabbedPieceInfo!==null||!this.board.match.gameRunning){this.html.addEventListener("mousedown",this.startFollowingCursor,{once:!0});return}this.board.showPossibleMoves(i,this.enemyTeamNum()),this.board.grabbedPieceInfo=new H(this,s),this.board.removePieceInPos(s,!1),this.html.id="move",this.moveToCursor(e),document.addEventListener("mousemove",this.moveToCursor),this.mouseHold().then(()=>{document.addEventListener("mouseup",n=>this.stopFollowingCursor(n,i),{once:!0})}).catch(()=>{document.addEventListener("mousedown",n=>this.stopFollowingCursor(n,i),{once:!0})})});c(this,"moveToCursor",e=>{e.preventDefault(),this.board.highlightFieldUnderMovingPiece(this.board.calcFieldCoorByPx(e.clientX,e.clientY));const t=this.html.style.transform,s=t.slice(t.indexOf("(")+1,t.indexOf(",")),i=t.slice(t.indexOf(",")+1,t.length-1),n=`${this.calcNewTranslateXValue(e.clientX)}px`,o=`${this.calcNewTranslateYValue(e.clientY)}px`,a=this.board.calcFieldCoorByPx(e.clientX,e.clientY),l=a.x===-1?s:n,h=a.y===-1?i:o;this.html.style.transform=`translate(${l}, ${h})`});c(this,"stopFollowingCursor",(e,t)=>{const s=this.board.grabbedPieceInfo;this.html.id="";const i=F;document.getElementById(i)&&(document.getElementById(i).id=""),document.removeEventListener("mousemove",this.moveToCursor),this.board.hidePossibleMoves();const n=this.board.calcFieldCoorByPx(e.clientX,e.clientY),o=s.grabbedFrom;for(let a=0;a<t.length;a++)if(t[a].isEqualTo(n)&&(n.x!==o.x||n.y!==o.y)){this.board.movePiece(o,n,s.piece,A),t=[],this.board.grabbedPieceInfo=null;return}this.board.placePieceInPos(o,s.piece,this.calcTransitionDelay(o,n)),this.board.grabbedPieceInfo=null});this.value=0,this.team=e,this.html=this.createNewHtmlPiece(),this.board=t,this.num=0,this.html.addEventListener("mousedown",this.startFollowingCursor,{once:!0})}createNewHtmlPiece(){const e=document.createElement("div");return e.classList.add("piece"),e}addClassName(e){const t=b.getClassNameByPiece(e,this.team);t!==null&&this.html.classList.add(t)}enemyTeamNum(){return this.team===g.white?g.black:g.white}getPossibleMovesFromPosForKing(e){return[]}getPossibleMovesFromPos(e){return[]}calcNewTranslateXValue(e){return e-(this.board.pageContainerHtml.offsetWidth-this.board.piecesHtml.offsetWidth)/2-this.html.offsetWidth/2}calcNewTranslateYValue(e){return e-(this.board.pageContainerHtml.offsetHeight-this.board.piecesHtml.offsetHeight)/2-this.html.offsetWidth/2}calcTransitionDelay(e,t){const s=Math.abs(t.x-e.x),i=Math.abs(t.y-e.y);return Math.sqrt(Math.pow(s,2)+Math.pow(i,2))*25}substractAbsPinsFromPossMoves(e,t,s){for(const i of t)i.pinnedPiecePos.isEqualTo(s)&&(e=e.filter(n=>{const o=this.num!==m.knight,a=new r(n.y-s.y,n.x-s.x,o);return a.isEqualTo(new r(0,0))||a.isEqualTo(i.pinDir)||a.isEqualTo(new r(-i.pinDir.y,-i.pinDir.x))}));return e}mouseHold(){return new Promise((e,t)=>{this.html.addEventListener("mouseup",()=>{t()},{once:!0}),setTimeout(()=>{e()},150)})}removePossMovesIfKingIsInCheck(e,t,s){if(t.checks.length===0)return e;if(t.checks.length===2)return[];for(let i=0;i<e.length;i++)if(!(e[i].x===s.x&&e[i].y===s.y))for(let n=0;n<t.checks.length;n++)this.moveIsCaptureOrIsOnTheWayOfACheck(t.checks[n],e[i])||(e.splice(i,1),i--);return e}moveIsCaptureOrIsOnTheWayOfACheck(e,t){const s=e.checkingPiecePos.x===t.x&&e.checkingPiecePos.y===t.y;let i=!1;for(const n of e.fieldsInBetweenPieceAndKing)t.isEqualTo(n)&&(i=!0);return s||i}sideEffectsOfMove(e,t){}static getPieceNumByName(e){switch(e){case"pawn":return m.pawn;case"rook":return m.rook;case"knight":return m.knight;case"bishop":return m.bishop;case"queen":return m.queen;case"king":return m.king;default:return null}}static getClassNameByPiece(e,t){const s=t===g.black?"b":"w",i=(()=>{switch(e){case m.king:return"king";case m.queen:return"queen";case m.bishop:return"bishop";case m.knight:return"knight";case m.rook:return"rook";case m.pawn:return"pawn";default:return null}})();return i===null?(console.error("Invalid piece number"),null):`${s}-${i}`}static createPromoteOptionHtml(e,t){const s=document.createElement("div");s.classList.add("promote-option");const i=b.getClassNameByPiece(e,t);return i!==null&&s.classList.add(i),s}}class S{constructor(e,t){c(this,"team");c(this,"board");c(this,"optionsHtmls");c(this,"html");c(this,"playerIsChoosing");this.team=e,this.board=t,this.optionsHtmls=[];const s=this.createArrOfPromoteOptionsHtml();this.html=this.createContainerHtml(s),this.board.html.append(this.html),this.playerIsChoosing=this.waitForPlayersDecision(s)}createContainerHtml(e){const t=this.board.piecesHtml.offsetWidth/f,s=document.createElement("div");s.classList.add("promote-popup"),s.style.setProperty("--widthOfFiveFields",`${t*5}px`),s.style.setProperty("--widthOfThreeFields",`${t*3}px`),s.style.setProperty("--quarterOfField",`${t*.25}px`);for(let i of e)s.append(i);return s}createArrOfPromoteOptionsHtml(){return[m.bishop,m.knight,m.rook,m.queen].map(t=>{const s=document.createElement("div"),i=b.createPromoteOptionHtml(t,this.team);return i.dataset.optNum=t.toString(),s.append(i),s})}waitForPlayersDecision(e){return new Promise(t=>{for(const s of e)s.addEventListener("click",i=>{const n=i.target,o=parseInt(n.dataset.optNum);t(o)},{once:!0})})}removeMenu(){this.html.remove()}}class L extends b{constructor(t,s){super(t,s);c(this,"directionY");this.num=m.pawn,this.value=1,this.directionY=this.team===g.white?-1:1,this.addClassName(this.num)}getPossibleMovesFromPosForKing(t){return[new d(t.y+this.directionY,t.x+1),new d(t.y+this.directionY,t.x-1)].filter(i=>this.board.isPosInBoard(i))}getPossibleMovesFromPos(t){const s=this.board.getKingByTeam(this.team),i=s.createArrOfAbsolutePins();let n=[t,...this.createArrOfNormalMoves(t),...this.createArrOfEnPassantCapturesPos(t)];return n=this.substractAbsPinsFromPossMoves(n,i,t),n=this.removePossMovesIfKingIsInCheck(n,s,t),n}createArrOfNormalMoves(t){const s=this.board,i=this.enemyTeamNum(),n=this.getPossibleMovesFromPosForKing(t).filter(a=>{var l;return((l=s.el[a.y][a.x].piece)==null?void 0:l.team)===i}),o=[];if(s.el[t.y+this.directionY][t.x].piece===null){o.push(new d(t.y+this.directionY,t.x));const a=this.directionY===1?1:f-2;t.y===a&&s.isPosInBoard(new d(t.y+this.directionY*2,t.x))&&s.el[t.y+this.directionY*2][t.x].piece===null&&o.push(new d(t.y+this.directionY*2,t.x))}return[...o,...n]}createArrOfEnPassantCapturesPos(t){const s=this.board,i=this.enemyTeamNum();return[new d(t.y,t.x+1),new d(t.y,t.x-1)].filter(o=>{var l,h;const a=new d(t.y+this.directionY,o.x);return s.isPosInBoard(a)&&((l=s.el[o.y][o.x].piece)==null?void 0:l.num)===m.pawn&&((h=s.el[o.y][o.x].piece)==null?void 0:h.team)===i&&s.el[o.y][o.x].piece===s.moves[s.moves.length-1].piece}).map(o=>new d(t.y+this.directionY,o.x))}sideEffectsOfMove(t){var n;const s=this.board;s.isPosInBoard(new d(t.y-this.directionY,t.x))&&((n=s.el[t.y-this.directionY][t.x].piece)==null?void 0:n.num)===m.pawn&&s.moves[s.moves.length-2].piece===s.el[t.y-this.directionY][t.x].piece&&s.removePieceInPos(new d(t.y-this.directionY,t.x),!0);const i=this.directionY===1&&!s.inverted?f-1:0;t.y===i&&this.promote(t)}promote(t){this.board.pawnPromotionMenu=new S(this.team,this.board),this.board.pawnPromotionMenu.playerIsChoosing.then(s=>{const i=this.board.createNewPieceObj(s,this.team);this.board.removePieceInPos(t,!0),this.board.placePieceInPos(t,i,0,!0),this.board.pawnPromotionMenu.removeMenu(),this.board.pawnPromotionMenu=null,this.board.getKingByTeam(this.enemyTeamNum()).updateChecksArr(),this.board.moves[this.board.moves.length-1].setPromotedTo(i)})}}class D extends b{constructor(t,s){super(t,s);c(this,"haventMovedYet");this.num=m.rook,this.value=5,this.haventMovedYet=!0,this.addClassName(this.num)}getPossibleMovesFromPosForKing(t){var o,a,l;const s=this.enemyTeamNum(),i=[],n=[new r(1,0),new r(-1,0),new r(0,1),new r(0,-1)];for(const h of n){const P=new d(t.y,t.x);for(;!(((o=this.board.el[P.y][P.x].piece)==null?void 0:o.team)===s&&((a=this.board.el[P.y][P.x].piece)==null?void 0:a.num)!==m.king||(P.x+=h.x,P.y+=h.y,!this.board.isPosInBoard(P))||(i.push(new d(P.y,P.x)),((l=this.board.el[P.y][P.x].piece)==null?void 0:l.team)===this.team)););}return i}getPossibleMovesFromPos(t){const s=this.board.getKingByTeam(this.team),i=s.createArrOfAbsolutePins();let n=[t,...this.createArrOfNormalMoves(t)];return n=this.substractAbsPinsFromPossMoves(n,i,t),n=this.removePossMovesIfKingIsInCheck(n,s,t),n}createArrOfNormalMoves(t){var o,a;const s=this.enemyTeamNum(),i=[new r(1,0),new r(-1,0),new r(0,1),new r(0,-1)],n=[];for(const l of i){const h=new d(t.y,t.x);for(;!(((o=this.board.el[h.y][h.x].piece)==null?void 0:o.team)===s||(h.x+=l.x,h.y+=l.y,!this.board.isPosInBoard(h)||((a=this.board.el[h.y][h.x].piece)==null?void 0:a.team)===this.team));)n.push(new d(h.y,h.x))}return n}sideEffectsOfMove(){this.haventMovedYet&&(this.haventMovedYet=!1)}}class Y extends b{constructor(e,t){super(e,t),this.num=m.knight,this.value=3,this.addClassName(this.num)}getPossibleMovesFromPosForKing(e){return[new r(1,2),new r(1,-2),new r(-1,2),new r(-1,-2),new r(2,1),new r(2,-1),new r(-2,1),new r(-2,-1)].map(s=>new d(e.y+s.y,e.x+s.x)).filter(s=>this.board.isPosInBoard(s))}getPossibleMovesFromPos(e){const t=this.board.getKingByTeam(this.team),s=t.createArrOfAbsolutePins();let i=[e,...this.createArrOfNormalMoves(e)];return i=this.substractAbsPinsFromPossMoves(i,s,e),i=this.removePossMovesIfKingIsInCheck(i,t,e),i}createArrOfNormalMoves(e){return this.getPossibleMovesFromPosForKing(e).filter(t=>{var s;return((s=this.board.el[t.y][t.x].piece)==null?void 0:s.team)!==this.team})}}class q extends b{constructor(e,t){super(e,t),this.num=m.bishop,this.value=3,this.addClassName(this.num)}getPossibleMovesFromPosForKing(e){var n,o,a;const t=this.enemyTeamNum();let s=[];const i=[new r(1,1),new r(-1,-1),new r(-1,1),new r(1,-1)];for(const l of i){const h=new d(e.y,e.x);for(;!(((n=this.board.el[h.y][h.x].piece)==null?void 0:n.team)===t&&((o=this.board.el[h.y][h.x].piece)==null?void 0:o.num)!==m.king||(h.x+=l.x,h.y+=l.y,!this.board.isPosInBoard(h))||(s.push(new d(h.y,h.x)),((a=this.board.el[h.y][h.x].piece)==null?void 0:a.team)===this.team)););}return s}getPossibleMovesFromPos(e){const t=this.board.getKingByTeam(this.team),s=t.createArrOfAbsolutePins();let i=[e,...this.createArrOfNormalMoves(e)];return i=this.substractAbsPinsFromPossMoves(i,s,e),i=this.removePossMovesIfKingIsInCheck(i,t,e),i}createArrOfNormalMoves(e){var n,o;const t=this.enemyTeamNum(),s=[],i=[new r(1,1),new r(-1,-1),new r(-1,1),new r(1,-1)];for(const a of i){let l=new d(e.y,e.x);for(;!(((n=this.board.el[l.y][l.x].piece)==null?void 0:n.team)===t||(l.x+=a.x,l.y+=a.y,!this.board.isPosInBoard(l)||((o=this.board.el[l.y][l.x].piece)==null?void 0:o.team)===this.team));)s.push(new d(l.y,l.x))}return s}}class $ extends b{constructor(e,t){super(e,t),this.num=m.queen,this.value=9,this.addClassName(this.num)}getPossibleMovesFromPosForKing(e){var n,o,a;const t=this.enemyTeamNum(),s=[],i=[new r(1,1),new r(-1,-1),new r(-1,1),new r(1,-1),new r(1,0),new r(-1,0),new r(0,1),new r(0,-1)];for(const l of i){const h=new d(e.y,e.x);for(;!(((n=this.board.el[h.y][h.x].piece)==null?void 0:n.team)===t&&((o=this.board.el[h.y][h.x].piece)==null?void 0:o.num)!==m.king||(h.x+=l.x,h.y+=l.y,!this.board.isPosInBoard(h))||(s.push(new d(h.y,h.x)),((a=this.board.el[h.y][h.x].piece)==null?void 0:a.team)===this.team)););}return s}getPossibleMovesFromPos(e){const t=this.board.getKingByTeam(this.team),s=t.createArrOfAbsolutePins();let i=[e,...this.createArrOfNormalMoves(e)];return i=this.substractAbsPinsFromPossMoves(i,s,e),i=this.removePossMovesIfKingIsInCheck(i,t,e),i}createArrOfNormalMoves(e){var n,o;const t=this.enemyTeamNum(),s=[new r(1,1),new r(-1,-1),new r(-1,1),new r(1,-1),new r(1,0),new r(-1,0),new r(0,1),new r(0,-1)],i=[];for(const a of s){const l=new d(e.y,e.x);for(;!(((n=this.board.el[l.y][l.x].piece)==null?void 0:n.team)===t||(l.x+=a.x,l.y+=a.y,!this.board.isPosInBoard(l)||((o=this.board.el[l.y][l.x].piece)==null?void 0:o.team)===this.team));)i.push(new d(l.y,l.x))}return i}}class R{constructor(e,t){c(this,"pinnedPiecePos");c(this,"pinDir");this.pinnedPiecePos=e,this.pinDir=t}}class W{constructor(e,t,s){c(this,"checkingPiecePos");c(this,"checkedKingPos");c(this,"board");c(this,"fieldsInBetweenPieceAndKing");this.checkingPiecePos=e,this.checkedKingPos=t,this.board=s,this.fieldsInBetweenPieceAndKing=this.createArrOfFieldsInBetweenCheckingPieceAndKing()}createArrOfFieldsInBetweenCheckingPieceAndKing(){var n,o;const e=this.checkingPiecePos;if(((n=this.board.el[e.y][e.x].piece)==null?void 0:n.num)===m.knight||((o=this.board.el[e.y][e.x].piece)==null?void 0:o.num)===m.pawn)return[];const t=new r(this.checkedKingPos.y-e.y,this.checkedKingPos.x-e.x,!0),s=new d(e.y+t.y,e.x+t.x),i=[];for(;s.x!==this.checkedKingPos.x||s.y!==this.checkedKingPos.y;)i.push(new d(s.y,s.x)),s.x+=t.x,s.y+=t.y;return i}}class x extends b{constructor(t,s){super(t,s);c(this,"haventMovedYet");c(this,"checks");this.num=m.king,this.value=0,this.haventMovedYet=!0,this.checks=[],this.addClassName(this.num)}getPossibleMovesFromPosForKing(t){return[new r(1,1),new r(-1,-1),new r(-1,1),new r(1,-1),new r(1,0),new r(-1,0),new r(0,1),new r(0,-1)].map(i=>new d(t.y+i.y,t.x+i.x)).filter(i=>this.board.isPosInBoard(i))}getPossibleMovesFromPos(t){const s=[t,...this.createArrOfNormalMoves(t),...this.createArrOfPossibleCastlePos(t)];return this.filterMovesSoKingCantMoveIntoCheck(s)}createArrOfNormalMoves(t){return[new r(1,1),new r(-1,-1),new r(-1,1),new r(1,-1),new r(1,0),new r(-1,0),new r(0,1),new r(0,-1)].map(i=>new d(t.y+i.y,t.x+i.x)).filter(i=>{var n;return this.board.isPosInBoard(i)&&((n=this.board.el[i.y][i.x].piece)==null?void 0:n.team)!==this.team})}createArrOfPossibleCastlePos(t){return this.createArrOfPossibleCastleDir(t).map(n=>new d(t.y+n.y*2,t.x+n.x*2))}createArrOfPossibleCastleDir(t){return this.haventMovedYet?[new r(0,1),new r(0,-1)].filter(s=>{const i=s.x>0?f-1:0,n=this.board.el[t.y][i].piece,o=new d(t.y,t.x+s.x),a=new d(t.y,t.x+s.x*2),l=[o,a],h=this.createArrOfFieldsXPosBetweenKingAndRook(i,t.x,s.x);return this.board.isPosInBoard(new d(a.y,a.x))&&(n==null?void 0:n.haventMovedYet)&&h.filter(P=>this.board.el[t.y][P].piece===null).length===h.length&&this.filterMovesSoKingCantMoveIntoCheck(l).length===l.length}):[]}createArrOfFieldsXPosBetweenKingAndRook(t,s,i){const n=[],o=Math.abs(t-s)-1;let a=s+i;for(;n.length<o;)n.push(a),a+=i;return n}filterMovesSoKingCantMoveIntoCheck(t){const s=this.enemyTeamNum(),i=this.board.el;for(let n=0;n<i.length;n++)for(let o=0;o<i[n].length;o++){if(i[n][o].piece===null||i[n][o].piece.team!==s)continue;const a=i[n][o].piece.getPossibleMovesFromPosForKing(new d(n,o));for(const l of a)t=t.filter(h=>(l.x!==h.x||l.y!==h.y)&&(l.x!==o||l.y!==n))}return t}createArrOfAbsolutePins(){var o,a,l,h,P,C,T;const t=this.board.findKingPos(this.team),s=this.enemyTeamNum();let i=[];const n=[new r(1,0),new r(-1,0),new r(0,1),new r(0,-1),new r(1,1),new r(-1,1),new r(1,-1),new r(-1,-1)];for(let y=0;y<n.length;y++){const O=n[y].x===0||n[y].y===0;let v=null,p=new d(t.y+n[y].y,t.x+n[y].x);for(;this.board.isPosInBoard(p);){if(this.board.el[p.y][p.x].piece!==null){if(v===null){if(((o=this.board.el[p.y][p.x].piece)==null?void 0:o.team)===s)break;v=new R(new d(p.y,p.x),n[y]),p.x+=n[y].x,p.y+=n[y].y;continue}if(((a=this.board.el[p.y][p.x].piece)==null?void 0:a.num)!==m.bishop&&((l=this.board.el[p.y][p.x].piece)==null?void 0:l.num)!==m.rook&&((h=this.board.el[p.y][p.x].piece)==null?void 0:h.num)!==m.queen||((P=this.board.el[p.y][p.x].piece)==null?void 0:P.team)===this.team)break;(O&&((C=this.board.el[p.y][p.x].piece)==null?void 0:C.num)!==m.bishop||!O&&((T=this.board.el[p.y][p.x].piece)==null?void 0:T.num)!==m.rook)&&i.push(v)}p.x+=n[y].x,p.y+=n[y].y}}return i}sideEffectsOfMove(t,s){if(this.haventMovedYet&&(this.haventMovedYet=!1),Math.abs(s.x-t.x)>1){const n=new r(0,t.x-s.x,!0),a=n.x===1?f-1:0,l=new d(s.y,a),h=new d(t.y,t.x+n.x*-1),P=this.board.el[l.y][l.x].piece;this.board.removePieceInPos(l,!1),this.board.placePieceInPos(h,P,A*3.5)}}updateChecksArr(){this.checks=[];const t=this.board.findKingPos(this.team),s=this.getPossitionsOfPiecesCheckingKing();for(const n of s)this.checks.push(new W(n,t,this.board));const i="king-check";document.querySelectorAll(`.${i}`).forEach(n=>{n.classList.remove(i)}),this.checks.length>0&&this.board.el[t.y][t.x].html.classList.add(i)}getPossitionsOfPiecesCheckingKing(){var n;const t=this.board.findKingPos(this.team),s=this.enemyTeamNum(),i=[];for(let o=0;o<this.board.el.length;o++)for(let a=0;a<this.board.el[o].length;a++){if(this.board.el[o][a].piece===null||((n=this.board.el[o][a].piece)==null?void 0:n.team)!==s)continue;const l=this.board.el[o][a].piece.getPossibleMovesFromPosForKing(new d(o,a));for(const h of l)t.x===h.x&&t.y===h.y&&i.push(new d(o,a))}return i}invertChecksArr(){for(const t of this.checks){t.checkedKingPos.invert(),t.checkingPiecePos.invert();for(const s of t.fieldsInBetweenPieceAndKing)s.invert()}}}class k{constructor(e,t,s,i){c(this,"piece");c(this,"from");c(this,"to");c(this,"capturedPiece");c(this,"promotedTo");this.piece=e,this.from=t,this.to=s,this.capturedPiece=i,this.promotedTo=null}setPromotedTo(e){this.promotedTo=e}static capturesAreEqual(...e){if(e.length===0)return console.error("Not enough captures to compare"),!1;const t=e[0];for(let s=1;s<e.length;s++)if(t!==e[s])return!1;return!0}}const M={arrowContainer:"arrow-container",arrowHead:"arrow-head",arrowTail:"arrow-tail"};class V{constructor(e,t,s){c(this,"board");c(this,"startPos");c(this,"endPos");c(this,"arrContainer");this.board=e,this.startPos=t,this.endPos=s;const i=new r(this.endPos.y-this.startPos.y,this.endPos.x-this.startPos.x);this.arrContainer=document.createElement("div"),this.drawArrowOnBoard(i)}drawArrowOnBoard(e){const t=Math.sqrt(Math.abs(Math.pow(Math.abs(e.x),2)+Math.pow(Math.abs(e.y),2))),s=this.board.html.offsetWidth/f,i=t*s,n=s/2,o=i-n,a=this.rotationDegOfVector(e);this.arrContainer.style.setProperty("--rotationDeg",`${-a}deg`),this.arrContainer.classList.add(M.arrowContainer),this.arrContainer.style.width=`${s*.8}px`,this.arrContainer.style.height=`${s*.8}px`;const l=document.createElement("div");l.style.setProperty("--headHeight",`${s/2+o}px`),l.classList.add(M.arrowHead),l.style.width=`${s}px`,l.style.height=`${s}px`;const h=document.createElement("div");h.style.setProperty("--halfOfFieldSize",`${s/2}px`),h.classList.add(M.arrowTail),h.style.width=`${o+1}px`,h.style.height=`${s*.3}px`,this.arrContainer.append(h),this.arrContainer.append(l),this.board.el[this.startPos.y][this.startPos.x].html.append(this.arrContainer)}rotationDegOfVector(e){const t=180/Math.PI,s=Math.atan(Math.abs(e.y)/Math.abs(e.x))*t,i=this.rotationDegVerticallyOrHorizontally(e);if(i!==null)return i;const n=this.quadrantNum(e);return this.rotationDegDiagonally(s,n)}rotationDegVerticallyOrHorizontally(e){return e.y===0?e.simplifyDir(e.x)===1?0:180:e.x===0?e.simplifyDir(e.y)===-1?90:270:null}quadrantNum(e){const t=new r(e.simplifyDir(e.y),e.simplifyDir(e.x));return t.x===1?t.y===-1?1:4:t.y===-1?2:3}rotationDegDiagonally(e,t){switch(t){case 1:return e;case 2:return 180-e;case 3:return 180+e;case 4:return 360-e}}}class X{constructor(e){c(this,"arrows");c(this,"highlightClassName");c(this,"board");c(this,"handleMouseDown",e=>{if(e.button===0){this.removeAllArrows(),this.removeHighlightFromAllFields();return}if(e.button!==2)return;new Promise((s,i)=>{this.board.html.addEventListener("mouseup",()=>{i()},{once:!0}),setTimeout(()=>{s()},150)}).then(()=>{this.board.html.addEventListener("mouseup",s=>{const i=this.board.calcFieldCoorByPx(e.clientX,e.clientY),n=this.board.calcFieldCoorByPx(s.clientX,s.clientY);if(i.x===n.x&&i.y===n.y){this.toggleHighlightOnFieldOnPos(this.board.calcFieldCoorByPx(e.clientX,e.clientY));return}const o=this.indexOfEqualArrow(i,n);if(o!==-1){this.removeArrow(o);return}this.arrows.push(new V(this.board,i,n))},{once:!0})}).catch(()=>{this.toggleHighlightOnFieldOnPos(this.board.calcFieldCoorByPx(e.clientX,e.clientY))})});this.arrows=[],this.highlightClassName="highlighted-field",this.board=e}indexOfEqualArrow(e,t){for(let s=0;s<this.arrows.length;s++){const i=this.arrows[s].startPos,n=this.arrows[s].endPos;if(e.x===i.x&&e.y===i.y&&t.x===n.x&&t.y===n.y)return s}return-1}removeAllArrows(){for(;this.arrows.length>0;)this.removeArrow(0)}removeArrow(e){this.arrows[e].arrContainer.remove(),this.arrows.splice(e,1)}toggleHighlightOnFieldOnPos(e){this.board.el[e.y][e.x].html.classList.toggle(this.highlightClassName)}removeHighlightFromAllFields(){const e=document.getElementsByClassName(this.highlightClassName);for(let t=0;t<e.length;t++)e[t].classList.remove(this.highlightClassName),t--}}const f=8,F="field-heighlighted-under-moving-piece",w={field:"field",fieldColor1:"field1",fieldColor2:"field2",piece:"piece",possMove:"poss-move",possMoveCapture:"poss-move-capture",possMoveStart:"poss-move-start",thisHtml:"board-container",fieldsContainer:"board-fields-container",piecesContainer:"board-pieces-container"};class z{constructor(e,t,s,i){c(this,"match");c(this,"currTeam");c(this,"moves");c(this,"el");c(this,"html");c(this,"fieldsHtml");c(this,"piecesHtml");c(this,"pageContainerHtml");c(this,"grabbedPieceInfo");c(this,"kings");c(this,"visualizingSystem");c(this,"pawnPromotionMenu");c(this,"inverted");this.match=i,this.currTeam=t?g.white:g.black,this.moves=[],this.el=[],this.pageContainerHtml=document.querySelector(e),this.grabbedPieceInfo=null,this.visualizingSystem=new X(this),this.pawnPromotionMenu=null,this.inverted=!1,this.html=this.createBoardContainer(),this.fieldsHtml=this.createContainerForFields(),this.piecesHtml=this.createContainerForPieces(),this.pageContainerHtml.append(this.html),this.html.append(this.fieldsHtml),this.html.append(this.piecesHtml),this.createFields(),this.placePieces(s),this.kings=this.getKings(),this.updateFieldSize(),this.inverted&&this.flipPerspective(),this.html.addEventListener("mousedown",this.visualizingSystem.handleMouseDown)}createBoardContainer(){const e=document.createElement("div");return e.classList.add(w.thisHtml),e}createContainerForFields(){const e=document.createElement("div");return e.classList.add(w.fieldsContainer),e.addEventListener("contextmenu",t=>t.preventDefault()),e}createContainerForPieces(){const e=document.createElement("div");return e.classList.add(w.piecesContainer),e.addEventListener("contextmenu",t=>t.preventDefault()),e}setPieceTransitionDeley(e,t){e.style.setProperty("--transitionDuration",`${t}ms`)}createNewPieceObj(e,t){if(e===null||t===null)return null;switch(e){case m.pawn:return new L(t,this);case m.rook:return new D(t,this);case m.knight:return new Y(t,this);case m.bishop:return new q(t,this);case m.queen:return new $(t,this);case m.king:return new x(t,this);default:return null}}createFields(){this.el=[];let e=!0;for(let t=0;t<f;t++){this.el[t]=[];for(let s=0;s<f;s++){const i=this.createFieldHtml();s!==0&&(e=!e),i.classList.add(e?w.fieldColor1:w.fieldColor2),this.fieldsHtml.append(i),this.el[t][s]=new E(i)}}}createFieldHtml(){const e=document.createElement("div");return e.classList.add(w.field),e}placePieces(e){var s;const t=e===null?this.createMapOfPiecesInDefaultPos():this.convertMapOfPiecesForHumanToMapForScript(e);for(let i=0;i<this.el.length;i++)for(let n=0;n<this.el[i].length;n++)this.placePieceInPos(new d(i,n),t[i][n],0,Boolean((s=t[i][n])==null?void 0:s.html))}convertMapOfPiecesForHumanToMapForScript(e){let t=[];for(let s=0;s<e.length;s++){t.push([]);for(let i=0;i<e[s].length;i++){if(typeof e[s][i]=="number"){const o=e[s][i],a=e[s][i+1];for(let l=0;l<o;l++)t[s].push(this.createNewPieceObjByString(a));i++;continue}const n=e[s][i];t[s].push(this.createNewPieceObjByString(n))}}return t}createNewPieceObjByString(e){const t=this.getPieceTeamByString(e[0]),s=e.slice(1,e.length);return this.createNewPieceObj(b.getPieceNumByName(s),t)}getPieceTeamByString(e){switch(e){case"w":return g.white;case"b":return g.black;default:return null}}createMapOfPiecesInDefaultPos(){const e=[m.rook,m.knight,m.bishop,m.queen,m.king,m.bishop,m.knight,m.rook];return[e.map(t=>this.createNewPieceObj(t,g.black)),[...Array(f)].map(()=>this.createNewPieceObj(m.pawn,g.black)),...Array(f/2).fill(Array(f).fill(null)),[...Array(f)].map(()=>this.createNewPieceObj(m.pawn,g.white)),e.map(t=>this.createNewPieceObj(t,g.white))]}calcFieldCoorByPx(e,t){const s=(this.pageContainerHtml.offsetWidth-this.html.offsetWidth)/2,i=(this.pageContainerHtml.offsetHeight-this.html.offsetHeight)/2,n=e-s+1,o=t-i+1;let a=Math.ceil(n/this.html.offsetWidth*f)-1,l=Math.ceil(o/this.html.offsetHeight*f)-1;return(a<0||a>f-1)&&(a=-1),(l<0||l>f-1)&&(l=-1),new d(l,a)}highlightFieldUnderMovingPiece(e){const t=F;document.getElementById(t)&&(document.getElementById(t).id=""),e.y!==-1&&e.x!==-1&&(this.el[e.y][e.x].html.id=t)}placePieceInPos(e,t,s,i){if(t===null||!t.html){this.el[e.y][e.x].setPiece(t);return}const n=t.html;i&&this.piecesHtml.append(n),n.addEventListener("mousedown",t.startFollowingCursor,{once:!0}),this.setPieceTransitionDeley(n,s),this.transformPieceHtmlToPos(n,e),setTimeout(()=>{this.setPieceTransitionDeley(n,0)},s),this.el[e.y][e.x].setPiece(t)}transformPieceHtmlToPos(e,t){e.style.transform=`translate(
        ${t.x*this.piecesHtml.offsetWidth/f}px,
        ${t.y*this.piecesHtml.offsetHeight/f}px
      )`}getNextCurrTeam(e){return e===g.white?g.black:g.white}getKingByTeam(e){const t=this.findKingPos(e);return this.el[t.y][t.x].piece}movePiece(e,t,s,i){const n=this.el[t.y][t.x].piece;n!==null&&this.removePieceInPos(t,!0),this.moves.push(this.createNewMoveObj(s,e,t,n)),this.currTeam=this.getNextCurrTeam(this.currTeam),this.placePieceInPos(t,s,i),s.sideEffectsOfMove(t,e),this.getKingByTeam(s.enemyTeamNum()).updateChecksArr(),this.match.checkIfGameShouldEndAfterMove(this.moves[this.moves.length-1])}createNewMoveObj(e,t,s,i){return this.inverted&&(t.invert(),s.invert()),new k(e,t,s,i)}removePieceInPos(e,t){var s;t&&((s=this.el[e.y][e.x].piece)==null||s.html.remove()),this.el[e.y][e.x].setPiece(null)}getKings(){var i;let e=null,t=null,s={white:new x(g.white,this),black:new x(g.black,this)};for(let n=0;n<this.el.length;n++)for(let o=0;o<this.el[n].length;o++)if(((i=this.el[n][o].piece)==null?void 0:i.num)===m.king)switch(this.el[n][o].piece.team){case g.white:if(e!==null)return this.match.end(),alert("Too many kings"),s;e=this.el[n][o].piece;break;case g.black:if(t!==null)return this.match.end(),alert("Too many kings"),s;t=this.el[n][o].piece;break}return e===null||t===null?(this.match.end(),alert("Not enough kings on the board")):s={white:e,black:t},s}findKingPos(e){var t,s;for(let i=0;i<f;i++)for(let n=0;n<f;n++)if(((t=this.el[i][n].piece)==null?void 0:t.num)===m.king&&((s=this.el[i][n].piece)==null?void 0:s.team)===e)return new d(i,n);return new d(-1,-1)}showPossibleMoves(e,t){var i;const s=document.querySelector(":root");s.style.setProperty("--possMoveSize",`${this.html.offsetWidth/f/3}px`),s.style.setProperty("--possMoveStartSize",`${this.html.offsetWidth/f/3.75}px`);for(let n=0;n<e.length;n++){const o=e[n],a=document.createElement("div");a.classList.add(w.possMove),((i=this.el[o.y][o.x].piece)==null?void 0:i.team)===t&&a.classList.add(w.possMoveCapture),n===0&&a.classList.add(w.possMoveStart),a.dataset.possMove="",this.el[o.y][o.x].html.append(a)}}hidePossibleMoves(){document.querySelectorAll("[data-poss-move]").forEach(e=>{e.remove()})}createArrOfPieces(){return this.el.map(e=>e.map(t=>t.piece))}flipPerspective(){var i;const e=this.createArrOfPieces(),t=this.invertMap(e);for(let n=0;n<t.length;n++)for(let o=0;o<t[n].length;o++)((i=t[n][o])==null?void 0:i.num)===m.pawn&&(t[n][o].directionY*=-1),this.placePieceInPos(new d(n,o),t[n][o],0,!0);const s=this.getKingByTeam(this.currTeam);s!==null&&s.invertChecksArr(),this.inverted=!this.inverted}invertMap(e){return e.reverse().map(t=>t.reverse())}insufficientMaterialThatLeadsToDraw(){return this.isPositionKingVsKing()||this.isPositionKingAndBishopVsKing()||this.isPositionKingAndKnightVsKing()||this.isPositionKingAndBishopVsKingAndBishop()}isPositionKingVsKing(){for(let e=0;e<this.el.length;e++)for(let t=0;t<this.el[e].length;t++)if(this.el[e][t].piece!==null&&this.el[e][t].piece.num!==m.king)return!1;return!0}isPositionKingAndBishopVsKing(){return this.onlyTwoKingsAndSomePieceLeft(m.bishop)}isPositionKingAndKnightVsKing(){return this.onlyTwoKingsAndSomePieceLeft(m.knight)}onlyTwoKingsAndSomePieceLeft(e){var s,i;let t=0;for(let n=0;n<this.el.length;n++)for(let o=0;o<this.el[n].length;o++){if(((s=this.el[n][o].piece)==null?void 0:s.num)===e){if(t>0)return!1;t++;continue}if(this.el[n][o].piece!==null&&((i=this.el[n][o].piece)==null?void 0:i.num)!==m.king)return!1}return!0}isPositionKingAndBishopVsKingAndBishop(){var t,s;let e=[];for(let i=0;i<this.el.length;i++)for(let n=0;n<this.el[i].length;n++){if(((t=this.el[i][n].piece)==null?void 0:t.num)===m.bishop){if(e.length>=2)return!1;e.push(new d(i,n));continue}if(this.el[i][n].piece!==null&&((s=this.el[i][n].piece)==null?void 0:s.num)!==m.king)return!1}return this.isTwoEnemyBishopsOnTheSameColor(e)}isTwoEnemyBishopsOnTheSameColor(e){if(e.length!==2)return!1;const t=this.el[e[0].y][e[0].x].piece,s=this.el[e[1].y][e[1].x].piece,i=t.team!==s.team,n=this.isPositionsOnTheSameColor(e[0],e[1]);return i&&n}isPositionsOnTheSameColor(e,t){const s=this.el[e.y][e.x].html.className.includes(w.fieldColor1),i=this.el[t.y][t.x].html.className.includes(w.fieldColor1);return s===i}noCapturesOrPawnMovesIn50Moves(){if(this.moves.length<50)return!1;for(let e=this.moves.length-1;e>this.moves.length-1-50;e--)if(this.moves[e].capturedPiece!==null||this.moves[e].piece.num===m.pawn)return!1;return!0}threeMovesRepetition(){if(this.moves.length<6)return!1;const e=this.moves.length-1,t=[this.moves[e-4],this.moves[e-2],this.moves[e]],s=[this.moves[e-5],this.moves[e-3],this.moves[e-1]];return t[0].from.isEqualTo(t[1].to)&&t[1].from.isEqualTo(t[2].to)&&s[0].from.isEqualTo(s[1].to)&&s[1].from.isEqualTo(s[2].to)&&t[0].piece===t[2].piece&&s[0].piece===s[2].piece&&k.capturesAreEqual(t[0].capturedPiece,t[1].capturedPiece,t[2].capturedPiece)&&k.capturesAreEqual(s[0].capturedPiece,s[1].capturedPiece,s[2].capturedPiece)}isPosInBoard(e){return e.x>=0&&e.x<=f-1&&e.y>=0&&e.y<=f-1}updateFieldSize(){document.querySelector(":root").style.setProperty("--fieldSize",`${this.html.offsetWidth/f}px`)}}class N{constructor(e,t,s,i,n){c(this,"name");c(this,"image");c(this,"team");c(this,"points");c(this,"timeS");c(this,"board");this.name=e,this.image=this.getImage(t),this.team=s,this.points=0,this.timeS=i,this.board=n}getImage(e){return null}countPoints(){var t;const e=this.board.el;this.points=0;for(let s=0;s<e.length;s++)for(let i=0;i<e[s].length;i++)((t=e[s][i].piece)==null?void 0:t.team)===this.team&&(this.points+=e[s][i].piece.value)}enemyTeamNum(){return this.team===g.white?g.black:g.white}hasMoves(){var t;const e=this.board.el;for(let s=0;s<e.length;s++)for(let i=0;i<e[s].length;i++)if(((t=e[s][i].piece)==null?void 0:t.team)===this.team){const n=e[s][i].piece.getPossibleMovesFromPos(new d(s,i));if(n.length!==0&&(n.length>1||!n[0].isEqualTo(new d(s,i))))return!0}return!1}}class I{constructor(e,t){c(this,"cousedBy");c(this,"type");this.cousedBy=e,this.type=t}}class j{constructor(e,t,s){c(this,"gameRunning");c(this,"players");c(this,"board");this.gameRunning=!0,this.board=new z(s.htmlPageContainerQSelector,s.whiteToPlay,s.startPositionsOfPieces,this),this.players={white:new N(e.name,e.image,e.team,e.timeS,this.board),black:new N(t.name,t.image,t.team,t.timeS,this.board)}}checkIfGameShouldEndAfterMove(e){const t=e.piece.team===g.white,s=t?this.players.white:this.players.black,i=t?this.board.kings.black:this.board.kings.white,n=t?this.players.black:this.players.white;if(this.board.insufficientMaterialThatLeadsToDraw()||this.board.threeMovesRepetition()||this.board.noCapturesOrPawnMovesIn50Moves()){this.end(new I(s,"draw"));return}if(!n.hasMoves()){const o=i.checks.length>0?"check-mate":"stale-mate";this.end(new I(s,o))}}end(e){this.gameRunning=!1,console.log("moves: ",this.board.moves),console.log(e?`Game has ended by ${e.cousedBy.name} with a ${e.type}`:"Game ended")}}let G=null;function _(){const u={name:"white",image:null,team:1,timeS:600},e={name:"black",image:null,team:2,timeS:600},t={htmlPageContainerQSelector:"[data-container]",whiteToPlay:!0,startPositionsOfPieces:G};new j(u,e,t)}_();
