var x=Object.defineProperty;var v=(d,t,e)=>t in d?x(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var h=(d,t,e)=>(v(d,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerpolicy&&(n.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?n.credentials="include":i.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class a{constructor(t,e){h(this,"x");h(this,"y");this.y=t,this.x=e}invert(t){return new a(t-1-this.y,t-1-this.x)}isEqualTo(t){return this.x===t.x&&this.y===t.y}}class N{constructor(t,e){h(this,"html");h(this,"piece");this.html=t,this.piece=e}}class l extends a{constructor(t,e,s){super(t,e),s&&(this.y=this.simplifyDir(t),this.x=this.simplifyDir(e))}simplifyDir(t){return t>=1?1:t<=-1?-1:0}}class k{constructor(t,e){h(this,"piece");h(this,"grabbedFrom");this.piece=t,this.grabbedFrom=e}}class f{constructor(t,e,s){h(this,"value");h(this,"num");h(this,"team");h(this,"html");h(this,"board");h(this,"possMoves");h(this,"startFollowingCursor",t=>{const e=this.html,s=0,i=this.board.getFieldCoorByPx(t.clientX,t.clientY);if(this.board.currTeam!==this.team||t.button!==s||this.board.pawnPromotionMenu!==null||this.board.grabbedPieceInfo!==null||!this.board.match.gameRunning){e.addEventListener("mousedown",this.startFollowingCursor,{once:!0});return}this.possMoves=this.getPossibleMovesFromPos(i),this.board.showPossibleMoves(this.possMoves,this.enemyTeamNum());let n=new Promise((o,r)=>{e.addEventListener("mouseup",()=>{r()},{once:!0}),setTimeout(()=>{o()},150)});this.board.grabbedPieceInfo=new k(this,i),this.board.removePieceInPos(i),e.id="move",this.moveToCursor(t),document.addEventListener("mousemove",this.moveToCursor),n.then(()=>{setTimeout(()=>{document.addEventListener("mouseup",this.stopFollowingCursor,{once:!0})})}).catch(()=>{setTimeout(()=>{document.addEventListener("mousedown",this.stopFollowingCursor,{once:!0})})})});h(this,"moveToCursor",t=>{const e=this.html;t.preventDefault(),this.board.highlightFieldUnderMovingPiece(this.board.getFieldCoorByPx(t.clientX,t.clientY));const s=e.style.transform,i=e.style.transform.slice(s.indexOf("translateX"),s.indexOf("translateY")-1),n=e.style.transform.slice(s.indexOf("translateY"),s.length),o=`translateX(${t.clientX-(this.board.pageContainerHtml.offsetWidth-this.board.piecesHtml.offsetWidth)/2-e.offsetWidth/2}px)`,r=`translateY(${t.clientY-(this.board.pageContainerHtml.offsetHeight-this.board.piecesHtml.offsetHeight)/2-e.offsetWidth/2}px)`,c=this.board.getFieldCoorByPx(t.clientX,t.clientY);e.style.transform=`${c.x===-1?i:o}
       ${c.y===-1?n:r}
      `});h(this,"stopFollowingCursor",t=>{const e=this.html,s=this.board.grabbedPieceInfo;e.id="",document.getElementById("fieldHighlightedUnderMovingPiece")&&(document.getElementById("fieldHighlightedUnderMovingPiece").id=""),document.removeEventListener("mousemove",this.moveToCursor),this.board.hidePossibleMoves();const i=this.board.getFieldCoorByPx(t.clientX,t.clientY),n=s.grabbedFrom;for(let o=0;o<this.possMoves.length;o++)if(this.possMoves[o].isEqualTo(i)&&(i.x!==s.grabbedFrom.x||i.y!==s.grabbedFrom.y)){this.board.movePiece(n,i,s.piece),this.possMoves=[],this.board.grabbedPieceInfo=null;return}this.board.placePieceInPos(s.grabbedFrom,s.piece),this.possMoves=[],this.board.grabbedPieceInfo=null});this.value=0,this.num=0,this.team=t,this.html=e,this.board=s,this.possMoves=[],this.html!==null&&this.html.addEventListener("mousedown",this.startFollowingCursor,{once:!0})}enemyTeamNum(){return this.team===this.board.whiteNum?this.board.blackNum:this.board.whiteNum}getPossibleMovesFromPosForKing(t){return[]}getPossibleMovesFromPos(t){return[]}substractAbsPinsFromPossMoves(t,e,s){for(let i=0;i<e.length;i++)if(e[i].pinnedPiecePos.x===s.x&&e[i].pinnedPiecePos.y===s.y)for(let n=0;n<t.length;n++){const o=this.num!==this.board.knightNum,r=new l(t[n].y-s.y,t[n].x-s.x,o);r.x===0&&r.y===0||r.x===e[i].pinDir.x&&r.y===e[i].pinDir.y||r.x*-1===e[i].pinDir.x&&r.y*-1===e[i].pinDir.y||(t.splice(n,1),n--)}return t}removePossMovesIfKingIsChecked(t,e,s){if(e.checks.length<=0)return t;if(e.checks.length===2)return[];for(let i=0;i<t.length;i++)if(!(t[i].x===s.x&&t[i].y===s.y))for(let n=0;n<e.checks.length;n++)this.moveIsACaptureOrIsOnTheWayOfACheck(e.checks[n],t[i])||(t.splice(i,1),i--);return t}moveIsACaptureOrIsOnTheWayOfACheck(t,e){const s=t.checkingPiecePos.x===e.x&&t.checkingPiecePos.y===e.y;let i=!1;for(let n of t.fieldsInBetweenPieceAndKing)e.isEqualTo(n)&&(i=!0);return s||i}sideEffectsOfMove(t,e){}}class M{constructor(t,e){h(this,"team");h(this,"board");h(this,"optionsHtmls");h(this,"html");h(this,"waitingForDecision");this.team=t,this.board=e,this.optionsHtmls=[];const s=this.board.piecesHtml.offsetWidth/this.board.fieldsInOneRow;this.html=document.createElement("div"),this.html.classList.add("promotePopup"),this.html.style.setProperty("--widthOfFiveFields",`${s*5}px`),this.html.style.setProperty("--widthOfThreeFields",`${s*3}px`),this.html.style.setProperty("--quarterOfField",`${s*.25}px`);const i=[this.board.bishopNum,this.board.knightNum,this.board.rookNum,this.board.queenNum];for(let n of i){const o=document.createElement("div"),r=this.board.getNewHtmlPiece(n,this.team,"promoteOption");r.dataset.optNum=n.toString(),this.optionsHtmls.push(r),o.append(r),this.html.append(o)}this.board.html.append(this.html),this.waitingForDecision=this.askWhatPiecePlayerWants()}askWhatPiecePlayerWants(){return new Promise(t=>{for(let e of this.optionsHtmls)e.addEventListener("click",s=>{const i=s.target,n=parseInt(i.dataset.optNum);t(n)},{once:!0})})}removeMenu(){this.html.remove()}}class I extends f{constructor(e,s,i){super(e,s,i);h(this,"directionY");this.num=1,this.value=1,this.directionY=this.team===this.board.whiteNum?-1:1}getPossibleMovesFromPosForKing(e){return[new a(e.y+this.directionY,e.x+1),new a(e.y+this.directionY,e.x-1)].filter(i=>this.board.posIsInBoard(i))}getPossibleMovesFromPos(e){const s=this.board,i=this.team===s.whiteNum?s.kings.white:s.kings.black,n=i.getPossitionsOfAbsolutePins();let o=this.getPossibleMovesFromPosForKing(e).filter(m=>s.el[m.y][m.x].piece.team===this.enemyTeamNum()),r=[e,...o];if(s.el[e.y+this.directionY][e.x].piece.num===this.board.noPieceNum){r.push(new a(e.y+this.directionY,e.x));const m=this.directionY===1?1:s.fieldsInOneRow-2;e.y===m&&s.posIsInBoard(new a(e.y+this.directionY*2,e.x))&&!s.el[e.y+this.directionY*2][e.x].piece.num&&r.push(new a(e.y+this.directionY*2,e.x))}const c=[new a(e.y,e.x+1),new a(e.y,e.x-1)];for(let m of c){const u=new a(e.y+this.directionY,m.x);s.posIsInBoard(u)&&s.el[m.y][m.x].piece.num===s.pawnNum&&s.el[m.y][m.x].piece.team===this.enemyTeamNum()&&s.el[m.y][m.x].piece===s.moves[s.moves.length-1].piece&&r.push(u)}return r=this.substractAbsPinsFromPossMoves(r,n,e),r=this.removePossMovesIfKingIsChecked(r,i,e),r}sideEffectsOfMove(e){const s=this.board;s.posIsInBoard(new a(e.y-this.directionY,e.x))&&s.el[e.y-this.directionY][e.x].piece.num===s.pawnNum&&s.moves[s.moves.length-2].piece===s.el[e.y-this.directionY][e.x].piece&&s.removePieceInPos(new a(e.y-this.directionY,e.x),!0);const i=this.directionY===1&&!s.inverted?s.fieldsInOneRow-1:0;e.y===i&&this.promote(e)}promote(e){this.board.pawnPromotionMenu=new M(this.team,this.board),this.board.pawnPromotionMenu.waitingForDecision.then(s=>{const i=this.board.getNewPieceObj(s,this.team);this.board.removePieceInPos(e,!0),this.board.placePieceInPos(e,i,!0),this.board.pawnPromotionMenu.removeMenu(),this.board.pawnPromotionMenu=null})}}class O extends f{constructor(e,s,i){super(e,s,i);h(this,"haventMovedYet");this.num=2,this.value=5,this.haventMovedYet=!0}getPossibleMovesFromPosForKing(e){const s=this.enemyTeamNum();let i=[],n,o=[new l(1,0),new l(-1,0),new l(0,1),new l(0,-1)];for(let r of o)for(n=new a(e.y,e.x);!(this.board.el[n.y][n.x].piece.team===s&&this.board.el[n.y][n.x].piece.num!==this.board.kingNum||(n.x+=r.x,n.y+=r.y,!this.board.posIsInBoard(n))||(i.push(new a(n.y,n.x)),this.board.el[n.y][n.x].piece.team===this.team)););return i}getPossibleMovesFromPos(e){const s=this.enemyTeamNum(),i=this.team===this.board.whiteNum?this.board.kings.white:this.board.kings.black,n=i.getPossitionsOfAbsolutePins();let o=[e],r,c=[new l(1,0),new l(-1,0),new l(0,1),new l(0,-1)];for(let m of c)for(r=new a(e.y,e.x);!(this.board.el[r.y][r.x].piece.team===s||(r.x+=m.x,r.y+=m.y,!this.board.posIsInBoard(r)||this.board.el[r.y][r.x].piece.team===this.team));)o.push(new a(r.y,r.x));return o=this.substractAbsPinsFromPossMoves(o,n,e),o=this.removePossMovesIfKingIsChecked(o,i,e),o}sideEffectsOfMove(){this.haventMovedYet&&(this.haventMovedYet=!1)}}class C extends f{constructor(t,e,s){super(t,e,s),this.num=3,this.value=3}getPossibleMovesFromPosForKing(t){let e=[],s=[new l(1,2),new l(1,-2),new l(-1,2),new l(-1,-2),new l(2,1),new l(2,-1),new l(-2,1),new l(-2,-1)];for(let i of s){const n=new a(t.y+i.y,t.x+i.x);this.board.posIsInBoard(n)&&e.push(n)}return e}getPossibleMovesFromPos(t){const e=this.team===this.board.whiteNum?this.board.kings.white:this.board.kings.black,s=e.getPossitionsOfAbsolutePins();let i=this.getPossibleMovesFromPosForKing(t).filter(o=>this.board.el[o.y][o.x].piece.team!==this.team),n=[t,...i];return n=this.substractAbsPinsFromPossMoves(n,s,t),n=this.removePossMovesIfKingIsChecked(n,e,t),n}}class F extends f{constructor(t,e,s){super(t,e,s),this.num=4,this.value=3}getPossibleMovesFromPosForKing(t){let e=[],s,i=[new l(1,1),new l(-1,-1),new l(-1,1),new l(1,-1)];for(let n of i)for(s=new a(t.y,t.x);!(this.board.el[s.y][s.x].piece.team===this.enemyTeamNum()&&this.board.el[s.y][s.x].piece.num!==this.board.kingNum||(s.x+=n.x,s.y+=n.y,s.x<0||s.x>7||s.y<0||s.y>7)||(e.push(new a(s.y,s.x)),this.board.el[s.y][s.x].piece.team===this.team)););return e}getPossibleMovesFromPos(t){const e=this.team===this.board.whiteNum?this.board.kings.white:this.board.kings.black,s=e.getPossitionsOfAbsolutePins();let i=[t],n,o=[new l(1,1),new l(-1,-1),new l(-1,1),new l(1,-1)];for(let r of o)for(n=new a(t.y,t.x);!(this.board.el[n.y][n.x].piece.team===this.enemyTeamNum()||(n.x+=r.x,n.y+=r.y,n.x<0||n.x>7||n.y<0||n.y>7||this.board.el[n.y][n.x].piece.team===this.team));)i.push(new a(n.y,n.x));return i=this.substractAbsPinsFromPossMoves(i,s,t),i=this.removePossMovesIfKingIsChecked(i,e,t),i}}class T extends f{constructor(t,e,s){super(t,e,s),this.num=5,this.value=9}getPossibleMovesFromPosForKing(t){const e=this.enemyTeamNum();let s=[],i,n=[new l(1,1),new l(-1,-1),new l(-1,1),new l(1,-1),new l(1,0),new l(-1,0),new l(0,1),new l(0,-1)];for(let o of n)for(i=new a(t.y,t.x);!(this.board.el[i.y][i.x].piece.team===e&&this.board.el[i.y][i.x].piece.num!==this.board.kingNum||(i.x+=o.x,i.y+=o.y,!this.board.posIsInBoard(i))||(s.push(new a(i.y,i.x)),this.board.el[i.y][i.x].piece.team===this.team)););return s}getPossibleMovesFromPos(t){const e=this.enemyTeamNum(),s=this.team===this.board.whiteNum?this.board.kings.white:this.board.kings.black,i=s.getPossitionsOfAbsolutePins();let n=[t],o,r=[new l(1,1),new l(-1,-1),new l(-1,1),new l(1,-1),new l(1,0),new l(-1,0),new l(0,1),new l(0,-1)];for(let c of r)for(o=new a(t.y,t.x);!(this.board.el[o.y][o.x].piece.team===e||(o.x+=c.x,o.y+=c.y,!this.board.posIsInBoard(o)||this.board.el[o.y][o.x].piece.team===this.team));)n.push(new a(o.y,o.x));return n=this.substractAbsPinsFromPossMoves(n,i,t),n=this.removePossMovesIfKingIsChecked(n,s,t),n}}class K{constructor(t,e){h(this,"pinnedPiecePos");h(this,"pinDir");this.pinnedPiecePos=t,this.pinDir=e}}class B{constructor(t,e,s){h(this,"checkingPiecePos");h(this,"checkedKingPos");h(this,"board");h(this,"fieldsInBetweenPieceAndKing");this.checkingPiecePos=t,this.checkedKingPos=e,this.board=s,this.fieldsInBetweenPieceAndKing=this.getFieldsInBetweenCheckingPieceAndKing()}getFieldsInBetweenCheckingPieceAndKing(){const t=this.checkingPiecePos;if(this.board.el[t.y][t.x].piece.num===this.board.knightNum||this.board.el[t.y][t.x].piece.num===this.board.pawnNum)return[];const e=new l(this.checkedKingPos.y-t.y,this.checkedKingPos.x-t.x,!0);let s=[],i=new a(t.y+e.y,t.x+e.x);for(;i.x!==this.checkedKingPos.x||i.y!==this.checkedKingPos.y;)s.push(new a(i.y,i.x)),i.x+=e.x,i.y+=e.y;return s}}class p extends f{constructor(e,s,i){super(e,s,i);h(this,"haventMovedYet");h(this,"checks");this.num=6,this.value=0,this.haventMovedYet=!0,this.checks=[]}getPossibleMovesFromPosForKing(e){let s=[],i=[new l(1,1),new l(-1,-1),new l(-1,1),new l(1,-1),new l(1,0),new l(-1,0),new l(0,1),new l(0,-1)];for(let n of i){const o=new a(e.y+n.y,e.x+n.x);this.board.posIsInBoard(o)&&s.push(o)}return s}getPossibleMovesFromPos(e){const s=this.enemyTeamNum();let i=[e],n=[new l(1,1),new l(-1,-1),new l(-1,1),new l(1,-1),new l(1,0),new l(-1,0),new l(0,1),new l(0,-1)];const o=this.getPossibleCastlesDir(e),r=(()=>{let c=[];for(let m of o)c.push(new a(e.y+m.y,e.x+m.x));return c})();i.push(...r);for(let c of n){const m=new a(e.y+c.y,e.x+c.x);this.board.posIsInBoard(m)&&this.board.el[e.y+c.y][e.x+c.x].piece.team!==this.team&&i.push(m)}for(let c=0;c<this.board.el.length;c++)for(let m=0;m<this.board.el[c].length;m++){if(this.board.el[c][m].piece.team!==s)continue;const u=this.board.el[c][m].piece.getPossibleMovesFromPosForKing(new a(c,m));for(let g=0;g<u.length;g++)for(let w=1;w<i.length;w++)u[g].x===i[w].x&&u[g].y===i[w].y&&(u[g].x!==m||u[g].y!==c)&&(i.splice(w,1),w--)}return i}getPossibleCastlesDir(e){if(!this.haventMovedYet)return[];let s=[new l(0,2),new l(0,-2)];for(let i=0;i<s.length;i++){const n=s[i].simplifyDir(s[i].x)===1?this.board.fieldsInOneRow-1:0,o=this.board.el[e.y][n].piece;(!this.board.posIsInBoard(new a(e.y,e.x+s[i].x))||this.board.el[e.y][e.x+s[i].x/2].piece.num||this.board.el[e.y][e.x+s[i].x].piece.num||this.somePieceHasCheckOnWayOfCastle(new a(e.y,e.x+s[i].x/2))||this.somePieceHasCheckOnWayOfCastle(new a(e.y,e.x+s[i].x))||!o.haventMovedYet)&&(s.splice(i,1),i--)}return s}somePieceHasCheckOnWayOfCastle(e){const s=this.enemyTeamNum();for(let i=0;i<this.board.el.length;i++)for(let n=0;n<this.board.el[i].length;n++)if(!(this.board.el[i][n].piece.team!==s||this.board.el[i][n].piece.num===this.board.kingNum)&&this.board.el[i][n].piece.num!==this.board.pawnNum){const o=this.board.el[i][n].piece.getPossibleMovesFromPos(new a(i,n));for(let r of o)if(r.x===e.x&&r.y===e.y)return!0;continue}return!1}getPossitionsOfAbsolutePins(){const e=this.board.findKingsPos(this.team);let s=[],i=[new l(1,0),new l(-1,0),new l(0,1),new l(0,-1),new l(1,1),new l(-1,1),new l(1,-1),new l(-1,-1)];for(let n=0;n<i.length;n++){const o=i[n].x===0||i[n].y===0;let r=new a(e.y,e.x),c=null;for(r.x+=i[n].x,r.y+=i[n].y;this.board.posIsInBoard(r);){if(this.board.el[r.y][r.x].piece.num){if(!c){if(this.board.el[r.y][r.x].piece.team!==this.team)break;c=new K(new a(r.y,r.x),i[n]),r.x+=i[n].x,r.y+=i[n].y;continue}if(this.board.el[r.y][r.x].piece.num!==this.board.bishopNum&&this.board.el[r.y][r.x].piece.num!==this.board.rookNum&&this.board.el[r.y][r.x].piece.num!==this.board.queenNum||this.board.el[r.y][r.x].piece.team===this.team)break;(o&&this.board.el[r.y][r.x].piece.num!==this.board.bishopNum||!o&&this.board.el[r.y][r.x].piece.num!==this.board.rookNum)&&s.push(c)}r.x+=i[n].x,r.y+=i[n].y}}return s}sideEffectsOfMove(e,s){if(this.haventMovedYet&&(this.haventMovedYet=!1),Math.abs(s.x-e.x)>1){const n=new l(0,e.x-s.x,!0),r=n.x===1?this.board.fieldsInOneRow-1:0,c=new a(s.y,r),m=new a(e.y,e.x+n.x*-1),u=this.board.el[c.y][c.x].piece;this.board.removePieceInPos(c),this.board.placePieceInPos(m,u)}}updateChecksArr(){this.checks=[];const e=this.board.findKingsPos(this.team),s=this.getPossitionsOfPiecesCheckingKing();for(let i of s)this.checks.push(new B(i,e,this.board))}getPossitionsOfPiecesCheckingKing(){const e=this.board.findKingsPos(this.team);let s=[];for(let i=0;i<this.board.el.length;i++)for(let n=0;n<this.board.el[i].length;n++){if(this.board.el[i][n].piece.team!==this.enemyTeamNum())continue;const o=this.board.el[i][n].piece.getPossibleMovesFromPosForKing(new a(i,n));for(let r of o)e.x===r.x&&e.y===r.y&&s.push(new a(i,n))}return s}}class b{constructor(t,e,s,i){h(this,"piece");h(this,"from");h(this,"to");h(this,"capture");this.piece=t,this.from=e,this.to=s,this.capture=i}}class H{constructor(t,e,s){h(this,"board");h(this,"startPos");h(this,"endPos");h(this,"arrContainer");this.board=t,this.startPos=e,this.endPos=s;const i=new l(this.endPos.y-this.startPos.y,this.endPos.x-this.startPos.x);this.arrContainer=document.createElement("div"),this.drawArrowOnBoard(i)}drawArrowOnBoard(t){const e=Math.sqrt(Math.abs(Math.pow(Math.abs(t.x),2)+Math.pow(Math.abs(t.y),2))),s=this.board.html.offsetWidth/this.board.fieldsInOneRow,i=e*s,n=s/2,o=i-n,r=this.getRotationDegOfVector(t);this.arrContainer.style.setProperty("--rotationDeg",`${-r}deg`),this.arrContainer.classList.add("arrowContainer"),this.arrContainer.style.width=`${s*.8}px`,this.arrContainer.style.height=`${s*.8}px`;const c=document.createElement("div");c.style.setProperty("--headHeight",`${s/2+o}px`),c.classList.add("arrowHead"),c.style.width=`${s}px`,c.style.height=`${s}px`;const m=document.createElement("div");m.style.setProperty("--halfOfFieldSize",`${s/2}px`),m.classList.add("arrowTail"),m.style.width=`${o+1}px`,m.style.height=`${s*.3}px`,this.arrContainer.append(m),this.arrContainer.append(c),this.board.el[this.startPos.y][this.startPos.x].html.append(this.arrContainer)}getRotationDegOfVector(t){const e=180/Math.PI,s=Math.atan(Math.abs(t.y)/Math.abs(t.x))*e;if(t.y===0)return t.simplifyDir(t.x)===1?0:180;if(t.x===0)return t.simplifyDir(-t.y)===1?90:270;switch((()=>{const n=new l(t.simplifyDir(t.y),t.simplifyDir(t.x));return n.x===1?n.y===-1?1:4:n.y===-1?2:3})()){case 1:return s;case 2:return 180-s;case 3:return 180+s;case 4:return 360-s}}}class A{constructor(t){h(this,"arrows");h(this,"highlightClassName");h(this,"board");h(this,"actionsOnMouseDown",t=>{if(t.button===0){this.removeAllArrows(),this.removeHighlightFromAllFields();return}if(t.button!==2)return;new Promise((s,i)=>{this.board.html.addEventListener("mouseup",()=>{i()},{once:!0}),setTimeout(()=>{s()},150)}).then(()=>{this.board.html.addEventListener("mouseup",s=>{const i=this.board.getFieldCoorByPx(t.clientX,t.clientY),n=this.board.getFieldCoorByPx(s.clientX,s.clientY);if(i.x===n.x&&i.y===n.y){this.toggleHighlightOnFieldOnPos(this.board.getFieldCoorByPx(t.clientX,t.clientY));return}const o=this.getEqualArrowNum(i,n);if(o!==-1){this.removeArrow(o);return}this.arrows.push(new H(this.board,i,n))},{once:!0})}).catch(()=>{this.toggleHighlightOnFieldOnPos(this.board.getFieldCoorByPx(t.clientX,t.clientY))})});this.arrows=[],this.highlightClassName="highlighted",this.board=t}getEqualArrowNum(t,e){for(let s=0;s<this.arrows.length;s++){const i=this.arrows[s].startPos,n=this.arrows[s].endPos;if(t.x===i.x&&t.y===i.y&&e.x===n.x&&e.y===n.y)return s}return-1}removeAllArrows(){for(;this.arrows.length>0;)this.removeArrow(0)}removeArrow(t){this.arrows[t].arrContainer.remove(),this.arrows.splice(t,1)}toggleHighlightOnFieldOnPos(t){this.board.el[t.y][t.x].html.classList.toggle(this.highlightClassName)}removeHighlightFromAllFields(){const t=document.getElementsByClassName(this.highlightClassName);for(let e=0;e<t.length;e++)t[e].classList.remove(this.highlightClassName),e--}}class E{constructor(t,e,s,i){h(this,"match");h(this,"currTeam");h(this,"moves");h(this,"el");h(this,"html");h(this,"fieldsHtml");h(this,"piecesHtml");h(this,"pageContainerHtml");h(this,"fieldsInOneRow");h(this,"grabbedPieceInfo");h(this,"kings");h(this,"noPieceNum");h(this,"pawnNum");h(this,"rookNum");h(this,"knightNum");h(this,"bishopNum");h(this,"queenNum");h(this,"kingNum");h(this,"noTeamNum");h(this,"whiteNum");h(this,"blackNum");h(this,"visualizingSystem");h(this,"pawnPromotionMenu");h(this,"classNames");h(this,"inverted");this.match=s,this.currTeam=1,this.moves=[],this.el=[],this.html=document.querySelector(t),this.pageContainerHtml=document.querySelector(e),this.fieldsInOneRow=8,this.grabbedPieceInfo=null,this.visualizingSystem=new A(this),this.pawnPromotionMenu=null,this.noPieceNum=0,this.pawnNum=1,this.rookNum=2,this.knightNum=3,this.bishopNum=4,this.queenNum=5,this.kingNum=6,this.noTeamNum=0,this.whiteNum=1,this.blackNum=2,this.classNames={field:"field",fieldColor1:"field1",fieldColor2:"field2",piece:"piece",possMove:"possMove",possMoveCapture:"possMoveCapture",possMoveStart:"possMoveStart",fieldsContainer:"boardFieldsContainer",piecesContainer:"boardPiecesContainer"},this.inverted=!1,this.fieldsHtml=this.createContainerForFields(),this.piecesHtml=this.createContainerForPieces(),this.html.append(this.fieldsHtml),this.html.append(this.piecesHtml),this.createFields(),this.placePieces(i),this.kings=this.getKings(),this.updateFieldSize(),this.inverted&&this.flipPerspective(),this.html.addEventListener("mousedown",this.visualizingSystem.actionsOnMouseDown)}createContainerForFields(){const t=document.createElement("div");return t.classList.add(this.classNames.fieldsContainer),t.addEventListener("contextmenu",e=>e.preventDefault()),t}createContainerForPieces(){const t=document.createElement("div");return t.classList.add(this.classNames.piecesContainer),t.addEventListener("contextmenu",e=>e.preventDefault()),t}getNewPieceObj(t,e){switch(t){case this.pawnNum:return new I(e,this.getNewHtmlPiece(t,e,this.classNames.piece),this);case this.rookNum:return new O(e,this.getNewHtmlPiece(t,e,this.classNames.piece),this);case this.knightNum:return new C(e,this.getNewHtmlPiece(t,e,this.classNames.piece),this);case this.bishopNum:return new F(e,this.getNewHtmlPiece(t,e,this.classNames.piece),this);case this.queenNum:return new T(e,this.getNewHtmlPiece(t,e,this.classNames.piece),this);case this.kingNum:return new p(e,this.getNewHtmlPiece(t,e,this.classNames.piece),this);default:return new f(this.noTeamNum,null,this)}}getNewHtmlPiece(t,e,s){let i=document.createElement("div");return i.classList.add(s),i.style.backgroundImage=`url(/assets/images/${this.getPieceNameByNum(t,e)}.png)`,i}createFields(){this.el=[];let t=1;for(let e=0;e<this.fieldsInOneRow;e++){this.el[e]=[];for(let s=0;s<this.fieldsInOneRow;s++){s!==0&&(t=t===1?2:1);let i=document.createElement("div");if(i.classList.add(this.classNames.field),i.classList.add(t===1?this.classNames.fieldColor1:this.classNames.fieldColor2),this.fieldsHtml.append(i),this.el[e][s]=new N(i,this.getNewPieceObj(this.noPieceNum,this.noTeamNum)),this.el[e][s].piece.html){const n=this.el[e][s].piece.html;this.piecesHtml.append(n),n.style.transform=`translateX(
              ${s*this.piecesHtml.offsetWidth/this.fieldsInOneRow}px
            )
            translateY(
              ${e*this.piecesHtml.offsetWidth/this.fieldsInOneRow}px
            )`}}}}placePieces(t){const e=t?this.convertMapOfPiecesForHumanToMapForScript(t):this.getMapOfPiecesInDeafultPos();for(let s=0;s<this.el.length;s++)for(let i=0;i<this.el[s].length;i++)this.placePieceInPos(new a(s,i),e[s][i],Boolean(e[s][i].html))}convertMapOfPiecesForHumanToMapForScript(t){let e=[];for(let s=0;s<t.length;s++){e.push([]);for(let i=0;i<t[s].length;i++){if(typeof t[s][i]=="number"){const o=t[s][i],r=t[s][i+1];for(let c=0;c<o;c++)e[s].push(this.getNewPieceObjByString(r));i++;continue}const n=t[s][i];e[s].push(this.getNewPieceObjByString(n))}}return e}getNewPieceObjByString(t){const e=this.getPieceTeamByString(t[0]),s=t.slice(1,t.length);return this.getNewPieceObj(this.getPieceNumByName(s),e)}getPieceTeamByString(t){switch(t){case"w":return this.whiteNum;case"b":return this.blackNum;default:return this.noTeamNum}}getPieceNumByName(t){switch(t){case"pawn":return this.pawnNum;case"rook":return this.rookNum;case"knight":return this.knightNum;case"bishop":return this.bishopNum;case"queen":return this.queenNum;case"king":return this.kingNum;default:return this.noPieceNum}}getMapOfPiecesInDeafultPos(){const t=[this.rookNum,this.knightNum,this.bishopNum,this.queenNum,this.kingNum,this.bishopNum,this.knightNum,this.rookNum];let e=[];for(let s=0;s<this.fieldsInOneRow;s++){e[s]=[];const i=s<4?this.blackNum:this.whiteNum;if(s===0||s===this.fieldsInOneRow-1){for(let o of t)e[s].push(this.getNewPieceObj(o,i));continue}const n=s===1||s===this.fieldsInOneRow-2?this.pawnNum:this.noPieceNum;for(let o=0;o<this.fieldsInOneRow;o++)e[s].push(this.getNewPieceObj(n,n===this.noPieceNum?this.noTeamNum:i))}return e}invertMap(t){let e=[];for(let s=t.length-1;s>=0;s--){e[e.length]=[];for(let i=t[s].length-1;i>=0;i--)e[e.length-1].push(t[s][i])}return e}getFieldCoorByPx(t,e){const s=(this.pageContainerHtml.offsetWidth-this.html.offsetWidth)/2,i=(this.pageContainerHtml.offsetHeight-this.html.offsetHeight)/2,n=t-s,o=e-i;let r=Math.ceil(n/this.html.offsetWidth*this.fieldsInOneRow)-1,c=Math.ceil(o/this.html.offsetHeight*this.fieldsInOneRow)-1;return(r<0||r>this.fieldsInOneRow-1)&&(r=-1),(c<0||c>this.fieldsInOneRow-1)&&(c=-1),new a(c,r)}highlightFieldUnderMovingPiece(t){document.getElementById("fieldHighlightedUnderMovingPiece")&&(document.getElementById("fieldHighlightedUnderMovingPiece").id=""),t.y!==-1&&t.x!==-1&&(this.el[t.y][t.x].html.id="fieldHighlightedUnderMovingPiece")}getPieceNameByNum(t,e){let s;switch(t){case this.pawnNum:s="pawn";break;case this.rookNum:s="rook";break;case this.knightNum:s="knight";break;case this.bishopNum:s="bishop";break;case this.queenNum:s="queen";break;default:s="king";break}let i=e===this.blackNum?"B":"W";return`${s}${i}`}placePieceInPos(t,e,s){s&&e.html&&this.piecesHtml.append(e.html),e.html&&(e.html.addEventListener("mousedown",e.startFollowingCursor,{once:!0}),e.html.style.transform=`translateX(
        ${t.x*this.piecesHtml.offsetWidth/this.fieldsInOneRow}px
      )
      translateY(
        ${t.y*this.piecesHtml.offsetWidth/this.fieldsInOneRow}px
      )`),this.el[t.y][t.x].piece=e}movePiece(t,e,s){const i=this.el[e.y][e.x].piece.html!==null;i&&this.removePieceInPos(e,!0),this.el[t.y][t.x].piece.num&&(this.el[t.y][t.x].piece=new f(0,null,this));const n=this.inverted?new b(s,t.invert(this.fieldsInOneRow),e.invert(this.fieldsInOneRow),i):new b(s,t,e,i);this.moves.push(n),this.currTeam=this.currTeam===this.whiteNum?this.blackNum:this.whiteNum,this.placePieceInPos(e,s),s.sideEffectsOfMove(e,t),(s.team===this.whiteNum?this.kings.black:this.kings.white).updateChecksArr(),this.match.checkIfGameShouldEndAfterMove(this.moves[this.moves.length-1])}getEmptyFieldsPosAtBeginning(){let t=[];for(let e=2;e<6;e++)for(let s=0;s<this.fieldsInOneRow;s++)t.push(new a(e,s));return t}removePieceInPos(t,e){var s;e&&((s=this.el[t.y][t.x].piece.html)==null||s.remove()),this.el[t.y][t.x].piece=this.getNewPieceObj(this.noTeamNum,this.noTeamNum)}getKings(){let t=null,e=null,s={white:new p(this.noPieceNum,document.createElement("div"),this),black:new p(this.noPieceNum,document.createElement("div"),this)};for(let i=0;i<this.el.length;i++)for(let n=0;n<this.el[i].length;n++)if(this.el[i][n].piece.num===this.kingNum)switch(this.el[i][n].piece.team){case this.whiteNum:if(t!==null)return this.match.end(),alert("Too many kings"),s;t=this.el[i][n].piece;break;case this.blackNum:if(e!==null)return this.match.end(),alert("Too many kings"),s;e=this.el[i][n].piece;break}return t===null||e===null?(this.match.end(),alert("Not enough kings on the board")):s={white:t,black:e},s}findKingsPos(t){for(let e=0;e<this.fieldsInOneRow;e++)for(let s=0;s<this.fieldsInOneRow;s++)if(this.el[e][s].piece.num===this.kingNum&&this.el[e][s].piece.team===t)return new a(e,s);return new a(-1,-1)}showPossibleMoves(t,e){document.querySelector(":root").style.setProperty("--possMoveSize",`${this.html.offsetWidth/this.fieldsInOneRow/3}px`);for(let i=0;i<t.length;i++){const n=t[i],o=document.createElement("div");o.classList.add(this.classNames.possMove),this.el[n.y][n.x].piece.team===e&&o.classList.add(this.classNames.possMoveCapture),i===0&&o.classList.add(this.classNames.possMoveStart),o.dataset.possMove="",this.el[n.y][n.x].html.append(o)}}hidePossibleMoves(){document.querySelectorAll("[data-poss-move]").forEach(t=>{t.remove()})}flipPerspective(){const t=[];for(let i=0;i<this.el.length;i++){t[i]=[];for(let n=0;n<this.el[i].length;n++)t[i].push(this.el[i][n].piece)}const e=this.invertMap(t);for(let i=0;i<this.el.length;i++)for(let n=0;n<this.el[i].length;n++){if(e[i][n].num===this.pawnNum){const o=e[i][n];o.directionY*=-1}this.placePieceInPos(new a(i,n),e[i][n])}const s=this.currTeam===this.whiteNum?this.kings.white:this.kings.black;if(s!==null)for(let i of s.checks){i.checkedKingPos=i.checkedKingPos.invert(this.fieldsInOneRow),i.checkingPiecePos=i.checkingPiecePos.invert(this.fieldsInOneRow);for(let n=0;n<i.fieldsInBetweenPieceAndKing.length;n++)i.fieldsInBetweenPieceAndKing[n]=i.fieldsInBetweenPieceAndKing[n].invert(this.fieldsInOneRow)}this.inverted=!this.inverted}insufficientMaterialThatLeadsToDraw(){const t=this.onlyTwoKingsLeft(),e=this.onlyTwoKingsAndBishopLeft(),s=this.onlyTwoKingsAndKnightLeft(),i=this.onlyTwoKingsAndTwoBishopsLeft();return t||e||s||i}onlyTwoKingsLeft(){for(let t=0;t<this.el.length;t++)for(let e=0;e<this.el[t].length;e++)if(this.el[t][e].piece.num!==this.noPieceNum&&this.el[t][e].piece.num!==this.kingNum)return!1;return!0}onlyTwoKingsAndBishopLeft(){return this.onlyTwoKingsAndSomePieceLeft(this.bishopNum)}onlyTwoKingsAndKnightLeft(){return this.onlyTwoKingsAndSomePieceLeft(this.knightNum)}onlyTwoKingsAndSomePieceLeft(t){let e=0;for(let s=0;s<this.el.length;s++)for(let i=0;i<this.el[s].length;i++){if(this.el[s][i].piece.num===t){if(e)return!1;e++;continue}if(this.el[s][i].piece.num!==this.noPieceNum&&this.el[s][i].piece.num!==this.kingNum)return!1}return!0}onlyTwoKingsAndTwoBishopsLeft(){let t=[];for(let e=0;e<this.el.length;e++)for(let s=0;s<this.el[e].length;s++){if(this.el[e][s].piece.num===this.bishopNum){if(t.length>=2)return!1;t.push(new a(e,s));continue}if(this.el[e][s].piece.num!==this.noPieceNum&&this.el[e][s].piece.num!==this.kingNum)return!1}return this.twoEnemyBishopsOnTheSameColor(t)}twoEnemyBishopsOnTheSameColor(t){if(t.length!==2)return!1;const e=this.el[t[0].y][t[0].x].piece,s=this.el[t[1].y][t[1].x].piece,i=e.team!==s.team,n=this.positionsOnTheSameColor(t[0],t[1]);return i&&n}positionsOnTheSameColor(t,e){const s=this.hasClass(this.el[t.y][t.x].html,this.classNames.fieldColor1),i=this.hasClass(this.el[e.y][e.x].html,this.classNames.fieldColor1);return s===i}hasClass(t,e){return t.className.includes(e)}noCapturesOrPawnMovesIn50Moves(){if(this.moves.length<50)return!1;for(let t=this.moves.length-1;t>this.moves.length-1-50;t--)if(this.moves[t].capture||this.moves[t].piece.num===this.pawnNum)return!1;return!0}threeMovesRepetition(){if(this.moves.length<6)return!1;const t=this.moves.length-1,e=[this.moves[t-4],this.moves[t-2],this.moves[t]],s=[this.moves[t-5],this.moves[t-3],this.moves[t-1]];return e[0].from.isEqualTo(e[1].to)&&e[1].from.isEqualTo(e[2].to)&&s[0].from.isEqualTo(s[1].to)&&s[1].from.isEqualTo(s[2].to)}posIsInBoard(t){return t.x>=0&&t.x<=this.fieldsInOneRow-1&&t.y>=0&&t.y<=this.fieldsInOneRow-1}updateFieldSize(){document.querySelector(":root").style.setProperty("--fieldSize",`${this.html.offsetWidth/this.fieldsInOneRow}px`)}}class P{constructor(t,e,s,i,n){h(this,"name");h(this,"image");h(this,"team");h(this,"points");h(this,"timeS");h(this,"board");this.name=t,this.image=this.getImage(e),this.team=s,this.points=0,this.timeS=i,this.board=n}getImage(t){return null}countsPoints(){const t=this.board;this.points=0;for(let e=0;e<t.el.length;e++)for(let s=0;s<t.el[e].length;s++)t.el[e][s].piece.team===this.team&&(this.points+=t.el[e][s].piece.value)}enemyTeamNum(){return this.team===this.board.whiteNum?this.board.blackNum:this.board.whiteNum}hasMoves(){const t=this.board.el;for(let e=0;e<t.length;e++)for(let s=0;s<t[e].length;s++)if(t[e][s].piece.team===this.team&&t[e][s].piece.getPossibleMovesFromPos(new a(e,s)).length>1)return!0;return!1}}class y{constructor(t,e){h(this,"cousedBy");h(this,"type");this.cousedBy=t,this.type=e}}class L{constructor(t,e,s){h(this,"gameRunning");h(this,"players");h(this,"board");this.gameRunning=!0,this.board=new E(s.htmlQSelector,s.htmlPageContainerQSelector,this,s.startPositionsOfPieces),this.players={white:new P(t.name,t.image,t.team,t.timeS,this.board),black:new P(e.name,e.image,e.team,e.timeS,this.board)}}checkIfGameShouldEndAfterMove(t){const e=t.piece.team===this.board.whiteNum,s=e?this.players.white:this.players.black,i=e?this.board.kings.black:this.board.kings.white,n=e?this.players.black:this.players.white;if(this.board.insufficientMaterialThatLeadsToDraw()||this.board.threeMovesRepetition()||this.board.noCapturesOrPawnMovesIn50Moves()){this.end(new y(s,"draw"));return}if(!n.hasMoves()){const o=i.checks.length>0?"check-mate":"stale-mate";this.end(new y(s,o))}}end(t){this.gameRunning=!1,console.log(this.board.moves),console.log(t?`Game has ended by ${t.cousedBy.name} with a ${t.type}`:"Game ended")}}let S;function R(){const d={name:"white",image:null,team:1,timeS:600},t={name:"black",image:null,team:2,timeS:600},e={htmlQSelector:"[data-board-container]",htmlPageContainerQSelector:"[data-container]",startPositionsOfPieces:S};new L(d,t,e)}R();
